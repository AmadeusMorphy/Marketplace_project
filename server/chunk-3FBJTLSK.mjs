import './polyfills.server.mjs';
import{c as j}from"./chunk-Q2SVOJO2.mjs";import{a as M}from"./chunk-DD2EPW5E.mjs";import{f as a}from"./chunk-Y2AHSHRF.mjs";import{a as u,b as _}from"./chunk-VC7RF3PE.mjs";import{I as A,v as I}from"./chunk-NONDWBOB.mjs";import{G as S,I as s,M as y,R as n,g as d,j as v,k as f,pa as b,v as l}from"./chunk-26VAK23Y.mjs";import{a as h,b as p,i as g}from"./chunk-AFOT676I.mjs";var C=class c{constructor(e,t,r,m,i){this.platformId=e;this._httpClient=t;this._router=r;this._messageService=m;this._merchantService=i;this.isBrowser=I(this.platformId)}isBrowser;isAuthenticatedSubject=new d(!1);isAuthenticated$=this.isAuthenticatedSubject.asObservable();getHeaders(){if(this.isBrowser){let e=localStorage.getItem("token");return new u({"Content-Type":"application/json",Authorization:`Bearer ${e}`})}return new u({"Content-Type":"application/json"})}onLogin(e){return this._httpClient.post(`${a.serverAuth}login`,e).pipe(s({next:t=>{let r=t.user;localStorage.setItem("token",t.token),localStorage.setItem("userId",r.id),localStorage.setItem("userType",r.userType),localStorage.setItem("email",r.email),localStorage.setItem("theme",r.theme),localStorage.setItem("fullName",r.fullName),localStorage.getItem("userType")==="merchant"&&this._merchantService.getMerchantProfile().subscribe(i=>{i.merchants.length===0?this._router.navigate(["/merchant-profile-register"]):(localStorage.setItem("fullName",i.full_name),this._router.navigate(["/merchant/dashboard"])),console.log("Merchant profile data: ",i)}),this.isAuthenticatedSubject.next(!0),this._messageService.add({severity:"success",summary:"Logged in"})},error:t=>{console.error("Error during login:",t),this._messageService.add({severity:"error",summary:"Login Failed",detail:t.error?.message||"Check your email and password."})}}))}onRegister(e){return this._httpClient.post(`${a.serverAuth}register`,e).pipe(s({next:t=>{console.log("successfully registered: ",t)},error:t=>{console.error("Error stuff: ",t)}}))}onMerchantRegister(e){let t=localStorage.getItem("userId"),r=localStorage.getItem("email"),m=localStorage.getItem("fullName"),i=p(h({},e),{email:r,full_name:m,status:"Pending"}),H={status:"Active"};return this._httpClient.post(`${a.server}merchants/profile`,i,{headers:this.getHeaders()}).pipe(s(o=>{console.log("Merchant registered: ",o)}),S(()=>this._httpClient.patch(`${a.server}users/profile?id=${t}`,H,{headers:this.getHeaders()}).pipe(s(o=>{console.log("Merchant user status updated: ",o),this._messageService.add({severity:"success",summary:"Success",detail:"Merchant completed registration!"})}),l(o=>(console.error("Error updating status, deleting merchant profile...",o),this._messageService.add({severity:"error",summary:"Error",detail:"Error registering merchant!"}),this._httpClient.delete(`${a.server}users/profile?id=${t}`,{headers:this.getHeaders()}).pipe(s(()=>{console.log("Deleted user profile due to error.")}),l(w=>(console.error("Error deleting user: ",w),v(null)))))))),l(o=>(console.error("Error registering merchant: ",o),this._messageService.add({severity:"error",summary:"Error",detail:"Server error, try again later!"}),f(()=>o))))}onLogout(){return this._httpClient.post(`${a.serverAuth}logout`,{},{headers:this.getHeaders()}).pipe(s({next:e=>{localStorage.clear(),console.log("Logged out: ",e),this.isAuthenticatedSubject.next(!1),this._router.navigate(["/home"])},error:e=>{localStorage.clear(),console.log("Logged out: "),this.isAuthenticatedSubject.next(!1),this._router.navigate(["/home"]),console.error("Error stuff: ",e)}}))}updateAuthState(e){return g(this,null,function*(){this.isAuthenticatedSubject.next(e)})}static \u0275fac=function(t){return new(t||c)(n(b),n(_),n(j),n(A),n(M))};static \u0275prov=y({token:c,factory:c.\u0275fac,providedIn:"root"})};export{C as a};
